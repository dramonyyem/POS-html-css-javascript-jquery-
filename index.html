<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- <script src="main.js" defer></script> -->
    <style>
        .modal-custom-size {
          max-width: 40%; /* Adjust width as needed */
          height: 60%; /* Adjust height if needed */
        }
    </style>

</head>
<body>
    <!-- <h1 id="msg">Loading...</h1> -->
    <hr>
    <h1 style="text-align:center;">
        P.O.S System
    </h1>
    <hr>
    <div class="mx-4">

        <div class="row">
            <div class="col-7 overflow-y-scroll" style="height:800px;">
                <div class="container">
                    <div class="mb-2">
                        <input type="text" id="searchInput" placeholder="Search...">
                    </div>
                </div>
                <div class="row justify-content">
                    <!-- @for ($i = 0;$i < 20;$i++) -->
                        <!-- <div class="card col-2 mx-4 my-4" style="width: 18rem;">
                            <img src="..." class="card-img-top" alt="...">
                            <div class="card-body">
                                <h5 class="card-title">Card title</h5>
                                <p class="card-text">Some quick example text to build on the card title and make up the bulk of the card's content.</p>
                                <button type='button' id="btn_1" class="btn btn-primary" onclick="getData({{ $i }})">Order</button>
                            </div>
                        </div> -->
                    <!-- @endfor -->
                </div>
            </div>
            <div class="col">
                <div class="container">

                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex">
                                <h1>Order Details</h1>
                                <!-- {{-- <button class="btn btn-primary float-end">Print</button> --}} -->

                            </div>

                        </div>
                        <div class="mx-2">

                            <table class="table table-striped table-hover" id="myTable" width=100%>
                                <thead>
                                  <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Product</th>
                                    <th scope="col">Price/Unit</th>
                                    <th scope="col">QTY</th>
                                    <th></th>
                                  </tr>
                                </thead>
                                <tbody>

                                </table>
                                </tbody>
                        </div>
                        <hr>
                        <div class="my-4">
                            <div class="row" style="text-align: right;">
                                <div class="col">
                                    <h5>Sub Total:</h5>
                                </div>
                                <div class="col">
                                    <div class="mx-4"><h5 id="sub_total">$0.00</h5></div>
                                </div>
                            </div>
                            <div class="row" style="text-align: right;">
                                <div class="col">
                                    <h3>Total Price:</h3>
                                </div>
                                <div class="col">
                                    <div class="mx-4"><h3 id="total_price">$0.00</h3></div>
                                </div>
                            </div>
                        </div>
                        </div>
                        <div class="my-2" id="checkoutBtn" style="display: none;">
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#checkOut">
                                Check Out
                            </button>
                        </div>
                    </div>
                </div>
        </div>
    </div>

    <!-- Modal Check out -->

    <div class="modal fade" id="checkOut" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header">
            <h1 class="modal-title fs-5" id="checkOutLabel">Check Out </h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <div class="mb-3">
                    <label for="amount" class="form-label">Enter Amount :<span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="amount" aria-describedby="amount" placeholder="Enter Number Only...">
                    <!-- <div id="emailHelp" class="form-text">We'll never share your email with anyone else.</div> -->
            </div>

            <div class="mb-3">
                <label for="amount_pay" class="form-label">Amount Pay : </label>
                <input type="number" class="form-control" id="amount_pay" aria-describedby="amount_pay" disabled>
                <!-- <div id="emailHelp" class="form-text">We'll never share your email with anyone else.</div> -->
        </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" style="display: none;" id="btnPrint" data-bs-toggle="modal" onclick="generateInvoice()" data-bs-target="#paymentInvoice" data-bs-dismiss="modal" class="btn btn-primary">Print</button>
        </div>
        </div>
    </div>
    </div>
      
    
    <div class="modal fade" id="paymentInvoice" data-bs-backdrop="static"  data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog modal-custom-size">
            <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="checkOutLabel">Receipt</h1>
                <!-- <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> -->
            </div>
            <div class="modal-body">
                <div class="shadow-none p-3 mb-5 bg-body-tertiary rounded">

                    <div class="row">
                        <div class="col">
                            <h4>Company Name</h4>
                        </div>
                        <div class="col" style="text-align: right;">
                            <div>
                                <span style="font-size: 4;">Address : Phnom Penh 2004 Kakab</span>
                            </div>
                            <div>
                                <span style="font-size: 4;">Phone Number : +885 815 128 8</span>
                            </div>
                            <div>
                                <span style="font-size: 4;">Email : yem.daramony@gmail.com</span>
                            </div>

                        </div>
                    </div>
                    <hr>
                    <table class="table" id="invoiceTable">
                        <thead>
                          <tr>
                            <th scope="col">Product name</th>
                            <th scope="col">Quantity</th>
                            <th scope="col">Price</th>
                          </tr>
                        </thead>
                        <tbody>
                        </tbody>
                      </table>
                    <hr>
                    <div class="row" style="text-align: right;">
                        <div class="col">
                            <h7>Total Paid : </h7> 
                        </div>
                        <div class="col">
                            <h7><span class="mx-4" id="total_amount_paid"></span></h7> 
                        </div>
                    </div>
                    <div class="row" style="text-align: right;">
                        <div class="col">
                            <h7>
                                <b>Total Amount :</b> 
                            </h7> 
                        </div>
                        <div class="col">
                            <h7><b><span class="mx-4" id="total_amount_pay"></span></b></h7> 
                        </div>
                    </div>

                    <div class="row" style="text-align: right;">
                        <div class="col">
                            <h7>VAT 0% : </h7> 
                        </div>
                        <div class="col">
                            <h7><span class="mx-4" id="">$ 0.00</span></h7> 
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <h7><b>Total Return : </b></h7> 
                        </div>
                        <div class="col" style="text-align: right;">
                            <h7><b><span class="mx-4" id="total_amount_return"></span></b></h7> 
                        </div>
                    </div>
                   
                    <hr>
                    <div style="text-align: center;">Thank You !!</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary"  onclick="window.location.reload();">Confirm</button>
            </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>

        const lsProduct = [];
        const lsPrice = [];

        // Example of updating localStorage
        var cards = [
            {
                id: 1,
                title: "Ice Latte",
                text: "",
                imageUrl: "https://via.placeholder.com/150",
                price: 10,
            },
            {
                id: 2,
                title: "Orange Juice",
                text: "",
                imageUrl: "https://via.placeholder.com/150",
                price: 10.5,

            },
            {
                id: 3,
                title: "Burger",
                text: "",
                imageUrl: "https://via.placeholder.com/150",
                price: 30,
            }
            // Add more cards as needed
        ];
        $('#searchInput').on('input', function() {
            var searchTerm = $(this).val().toLowerCase(); // Get the search term and convert to lowercase
            // Filter cards based on title or text matching the search term
            var filteredCards = cards.filter(function(card) {
                return card.title.toLowerCase().includes(searchTerm) || card.text.toLowerCase().includes(searchTerm);
            });
            // Re-render the cards based on the search term
            listData(filteredCards);
        });

        function generateInvoice(){
            $('#invoiceTable tbody').empty();
            let amount = 0;
            for (const product of lsProduct) {
                const productDetail = findProduct(product.product_id);
                amount += productDetail.price * product.product_qty;
                $('#invoiceTable').append(
                    '<tr><td>'+productDetail.title+'</td><td>x'+product.product_qty+'</td><td>$'+parseFloat(productDetail.price).toFixed(2)+'</td></tr>');  
            }
            
            let total_paid = parseFloat(document.getElementById('amount').value).toFixed(2);
            let total_return = total_paid - parseFloat(amount).toFixed(2);

            document.getElementById("total_amount_paid").textContent = "$" + total_paid;
            document.getElementById("total_amount_return").textContent = "$" + parseFloat(total_return).toFixed(2);

        }
        function isEmpty(value) {
            return (value == null || (typeof value === "string" && value.trim().length === 0));
        }
        document.getElementById('amount').addEventListener('keypress', function(event) {
            // Allow only numbers, decimal point, and control characters (e.g., backspace)
            var key = event.key;
            if (!/[\d\.]/.test(key) && key !== "Backspace" && key !== "ArrowLeft" && key !== "ArrowRight") {
                event.preventDefault(); // Prevent non-numeric input
            }
        });
        $("#amount").on('input', function(){
            var amount = $(this).val();
            console.log(amount);
            let totalPay = parseFloat($('#amount_pay').val());
            // if(isNaN(amount)){
            //     $(this).removeClass('is-invalid');
            // }

            if(parseFloat(amount) >= totalPay){
                $(this).removeClass('is-invalid');
                $("#btnPrint").show();
            }else{
                $(this).addClass('is-invalid');
                $("#btnPrint").hide();

            }
            if (isEmpty(amount)) {
                $(this).removeClass('is-invalid');
                $("#btnPrint").hide();

            }
        });
        function lsTableProduct(newLsProduct){
            document.getElementById("total_price").textContent = "";
            document.getElementById("sub_total").textContent = "";
            $('#myTable tbody').empty();
            let amount = 0;
            for (const product of newLsProduct) {
                const productDetail = findProduct(product.product_id);
                amount += productDetail.price * product.product_qty;
                $('#myTable').append(
                    '<tr><td>'+product.product_id+'</td><td>'+productDetail.title+'</td><td>$'+parseFloat(productDetail.price).toFixed(2)+'</td><td>'+product.product_qty+'</td><td><button class="btn btn-danger" type="button" onclick="removeCartItem('+product.product_id+')">Remove</button></td></tr>');  
            }
            document.getElementById("sub_total").textContent = "$" + parseFloat(amount).toFixed(2);
            document.getElementById("total_price").textContent = "$" + parseFloat(amount).toFixed(2);
            $('#amount_pay').val(parseFloat(amount).toFixed(2));
            if(newLsProduct.length == 0){
                $('#checkoutBtn').hide();
            }else{
                $('#checkoutBtn').show();
            }

            document.getElementById("total_amount_pay").textContent = "$" + parseFloat(amount).toFixed(2);
            // let total_paid = parseFloat($("#amount").val()).toFixed(2);
            

        }

        // function paymentInvoice(){
        //     $("")
        // } 

        function getData(item){
            let qty = 1;
            if(lsProduct.length == 0){                
                lsProduct.push({product_id : item , product_qty : 1});
            }else{
                if(!lsProduct.some(product => product.product_id === item)){
                    lsProduct.push({product_id : item , product_qty : qty});
                }else{
                    const index = lsProduct.findIndex(obj => obj.product_id === item );
                    lsProduct[index].product_qty = lsProduct[index].product_qty +1;
                }
            }

            lsTableProduct(lsProduct);
        }

        function findProduct(id){
            let index = cards.findIndex(p => parseInt(p.id) === parseInt(id));
            return cards[index];
        }
        
        function removeCartItem(id){
            let index = lsProduct.findIndex(p => parseInt(p.product_id) === parseInt(id));
            lsProduct.splice(index, 1);
            lsTableProduct(lsProduct);
        }

        function listData(lsCard){
            // Loop through the array of card data and append each card
            $(".row.justify-content").empty();
            for(let i = 0; i <= lsCard.length;i++){
                var cardHtml = `
                    <div class="card col-3 mx-4 my-4" style="width: 18rem;">
                        <img src="${lsCard[i].imageUrl}" class="card-img-top" alt="${lsCard[i].title}">
                        <div class="card-body">
                            <h5 class="card-title">${lsCard[i].title}</h5>
                            <p class="card-text">${lsCard[i].text}</p>
                            <p class="card-text">Price: $${parseFloat(lsCard[i].price).toFixed(2)}</p>

                            <button type='button' id="btn_${lsCard[i].id}" class="btn btn-primary" onclick="getData('${cards[i].id}')">Order</button>
                        </div>
                    </div>
                `;
                $(".row.justify-content").append(cardHtml);
            }
        }
        listData(cards);

        
    </script>